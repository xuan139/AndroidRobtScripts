<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>旅游与美食推荐</title>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    main {
      max-width: 960px;
      padding: 20px;
    }
    .card {
      border: 1px solid #ccc;
      border-radius: 10px;
      margin-bottom: 20px;
      padding: 15px;
      box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
    }
    .card img {
      width: 100%;
      border-radius: 8px;
    }
    #media-section {
      margin-top: 40px;
      text-align: center;
    }
    video, canvas {
      width: 320px;
      height: 240px;
      border-radius: 10px;
    }
    #controls {
      margin-top: 10px;
    }
    #startRecording, #stopRecording {
      font-size: 1.2em;
      padding: 10px 20px;
      margin: 0 10px;
    }
    @media (min-width: 768px) {
      #media-wrapper {
        display: flex;
        justify-content: center;
        gap: 20px;
      }
    }
  </style>
</head>
<body>

<main>
  <h1>欢迎来到美食与旅行推荐</h1>

  <div class="card">
    <h2>推荐餐馆：老张牛肉面</h2>
    <img src="https://source.unsplash.com/640x360/?noodles" alt="牛肉面" />
    <p>招牌牛肉拉面，汤鲜肉嫩，深受本地人喜爱。</p>
  </div>

  <div class="card">
    <h2>必去景点：青山湖</h2>
    <img src="https://source.unsplash.com/640x360/?lake" alt="青山湖" />
    <p>湖光山色，适合散步和野餐，摄影爱好者的天堂。</p>
  </div>
</main>

<section id="media-section">
  <h2>人脸检测与音频录制</h2>
  <div id="media-wrapper">
    <video id="camera" autoplay muted playsinline></video>
    <canvas id="overlay"></canvas>
  </div>
  <p id="status">状态：等待摄像头权限...</p>
  <div id="controls">
    <button id="startRecording" disabled>🎙️ 开始录音</button>
    <button id="stopRecording" disabled>🛑 停止录音</button>
    <br /><br />
    <audio id="audio" controls></audio>
  </div>
</section>

<script>
  const camera = document.getElementById('camera');
  const overlay = document.getElementById('overlay');
  const context = overlay.getContext('2d');
  const status = document.getElementById('status');
  const startButton = document.getElementById('startRecording');
  const stopButton = document.getElementById('stopRecording');
  const audioElement = document.getElementById('audio');
  let mediaRecorder;
  let audioChunks = [];

  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models')
  ])
  .then(() => navigator.mediaDevices.getUserMedia({ video: true, audio: true }))
  .then((stream) => {
    camera.srcObject = stream;
    camera.onloadedmetadata = () => {
      camera.play();
      startFaceDetection();
    };
  })
  .catch(err => {
    status.textContent = "无法访问摄像头或麦克风";
    console.error(err);
  });

  function startFaceDetection() {
    const size = { width: camera.videoWidth, height: camera.videoHeight };
    faceapi.matchDimensions(overlay, size);

    setInterval(async () => {
      const detections = await faceapi.detectAllFaces(camera, new faceapi.TinyFaceDetectorOptions());
      context.clearRect(0, 0, overlay.width, overlay.height);

      if (detections.length > 0) {
        status.textContent = `状态：检测到 ${detections.length} 张人脸`;
        startButton.disabled = false;
      } else {
        status.textContent = "状态：未检测到人脸";
        startButton.disabled = true;
      }

      const resized = faceapi.resizeResults(detections, size);
      faceapi.draw.drawDetections(overlay, resized);
    }, 300);
  }

  startButton.addEventListener('click', () => {
    mediaRecorder = new MediaRecorder(camera.srcObject);
    audioChunks = [];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioElement.src = URL.createObjectURL(audioBlob);
    };
    mediaRecorder.start();
    startButton.disabled = true;
    stopButton.disabled = false;
    status.textContent = "状态：正在录音...";
  });

  stopButton.addEventListener('click', () => {
    mediaRecorder.stop();
    startButton.disabled = false;
    stopButton.disabled = true;
    status.textContent = "状态：录音已停止";
  });
</script>

</body>
</html>
